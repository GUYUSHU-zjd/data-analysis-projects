---
// ✅ src/pages/projects/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';

// ✅ 将 getCollection 移入 getStaticPaths
export async function getStaticPaths() {
  let projects = [];
  try {
    const { getCollection } = await import('astro:content');
    projects = await getCollection('projects');
  } catch (error) {
    console.warn('无法获取项目内容集合:', error.message);
    return []; // 返回空数组，避免构建失败
  }

  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

// ✅ 从 Astro.props 获取当前项目
const { project } = Astro.props;
let Content = null;

// ✅ 渲染内容
if (project) {
  try {
    const rendered = await project.render();
    Content = rendered.Content;
  } catch (error) {
    console.warn(`无法渲染项目 "${project.slug}":`, error.message);
  }
}

// ✅ 安全访问属性
const title = project?.data?.title || '未命名项目';
const description = project?.data?.description || '';
const tools = project?.data?.tools || [];
const projectDate = project?.data?.date || project?.data?.pubDate;
const githubUrl = project?.data?.githubUrl || project?.data?.github_url;
const demoUrl = project?.data?.demoUrl || project?.data?.demo_url;
const image = project?.data?.image;
---

<BaseLayout title={`${title} | 数据分析作品集`}>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <!-- 项目头部 -->
    <header class="mb-8">
      <!-- 项目图片 -->
      {image && (
        <div class="mb-6 rounded-xl overflow-hidden shadow-md">
          <img 
            src={image} 
            alt={title}
            class="w-full h-64 object-cover"
          />
        </div>
      )}
      
      <h1 class="text-3xl font-bold text-gray-800 mb-2">{title}</h1>
      
      {description && (
        <p class="text-lg text-gray-600 mb-4">{description}</p>
      )}
      
      <!-- 元信息区域 -->
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 mb-4">
        {projectDate && !isNaN(new Date(projectDate)) && (
          <time 
            datetime={new Date(projectDate).toISOString()}
            class="inline-flex items-center"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            完成日期: {new Date(projectDate).toLocaleDateString('zh-CN')}
          </time>
        )}
        
        {tools.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {tools.map((tool) => (
              <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs">
                {tool}
              </span>
            ))}
          </div>
        )}
      </div>
      
      <!-- 项目链接 -->
      <div class="flex flex-wrap gap-4">
        {githubUrl && (
          <a 
            href={githubUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="inline-flex items-center px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors"
          >
            <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
            </svg>
            查看完整代码
          </a>
        )}
        
        {demoUrl && (
          <a 
            href={demoUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="inline-flex items-center px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
            </svg>
            查看在线演示
          </a>
        )}
        
        <a 
          href="/projects" 
          class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
          </svg>
          返回项目列表
        </a>
      </div>
    </header>

    <hr class="my-8 border-gray-200" />

    <!-- 项目正文内容 -->
    <div class="prose prose-lg max-w-none mb-12">
      {Content ? <Content /> : <p>无法加载项目内容。</p>}
    </div>
    
    <!-- 项目导航 -->
    <div class="flex justify-between pt-8 border-t border-gray-200">
      <a href="/projects" class="text-blue-600 hover:text-blue-800 font-medium inline-flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        所有项目
      </a>
      
      {githubUrl && (
        <a 
          href={githubUrl} 
          target="_blank" 
          rel="noopener noreferrer"
          class="text-blue-600 hover:text-blue-800 font-medium inline-flex items-center"
        >
          查看源代码
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </a>
      )}
    </div>
  </article>
</BaseLayout>

<style is:global>
  /* 基础样式重置 */
  article {
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  }
  
  /* 内容样式 */
  .prose {
    color: #374151;
    line-height: 1.75;
  }
  
  .prose h2 {
    color: #111827;
    font-weight: 600;
    font-size: 1.5em;
    margin-top: 2em;
    margin-bottom: 1em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .prose h3 {
    color: #111827;
    font-weight: 600;
    font-size: 1.25em;
    margin-top: 1.6em;
    margin-bottom: 0.6em;
  }
  
  .prose p {
    margin-bottom: 1.25em;
  }
  
  .prose ul, .prose ol {
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }
  
  .prose li {
    margin-bottom: 0.5em;
  }
  
  .prose li > ul,
  .prose li > ol {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  
  .prose strong {
    font-weight: 600;
    color: #111827;
  }
  
  .prose a {
    color: #2563eb;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  
  .prose a:hover {
    color: #1d4ed8;
  }
  
  .prose blockquote {
    font-weight: 500;
    font-style: italic;
    color: #4b5563;
    border-left-width: 0.25rem;
    border-left-color: #e5e7eb;
    quotes: "\201C""\201D""\2018""\2019";
    margin-top: 1.6em;
    margin-bottom: 1.6em;
    padding-left: 1em;
  }
  
  .prose blockquote p:first-of-type::before {
    content: open-quote;
  }
  
  .prose blockquote p:last-of-type::after {
    content: close-quote;
  }
  
  .prose code {
    color: #111827;
    font-weight: 600;
    font-size: 0.875em;
  }
  
  .prose code::before,
  .prose code::after {
    content: "`";
  }
  
  .prose pre {
    color: #e5e7eb;
    background-color: #1f2937;
    overflow-x: auto;
    font-size: 0.875em;
    line-height: 1.7142857;
    margin-top: 1.7142857em;
    margin-bottom: 1.7142857em;
    border-radius: 0.375rem;
    padding: 0.8571429em 1.1428571em;
  }
  
  .prose pre code {
    background-color: transparent;
    border-width: 0;
    border-radius: 0;
    padding: 0;
    font-weight: 400;
    color: inherit;
    font-size: inherit;
    font-family: inherit;
    line-height: inherit;
  }
  
  .prose pre code::before,
  .prose pre code::after {
    content: none;
  }
  
  .prose table {
    width: 100%;
    table-layout: auto;
    text-align: left;
    margin-top: 2em;
    margin-bottom: 2em;
    font-size: 0.875em;
    line-height: 1.7142857;
  }
  
  .prose thead {
    color: #111827;
    font-weight: 600;
    border-bottom-width: 1px;
    border-bottom-color: #d1d5db;
  }
  
  .prose thead th {
    vertical-align: bottom;
    padding-right: 0.5714286em;
    padding-bottom: 0.5714286em;
    padding-left: 0.5714286em;
  }
  
  .prose tbody tr {
    border-bottom-width: 1px;
    border-bottom-color: #e5e7eb;
  }
  
  .prose tbody tr:last-child {
    border-bottom-width: 0;
  }
  
  .prose tbody td {
    vertical-align: top;
    padding: 0.5714286em;
  }
  
  /* 响应式调整 */
  @media (max-width: 640px) {
    .prose {
      font-size: 0.875rem;
    }
    
    .prose h2 {
      font-size: 1.25em;
    }
    
    .prose h3 {
      font-size: 1.125em;
    }
  }
</style>